<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <script>
        ((win) => {
            let state;
            let storeEl;

            const set = (root, key, val) => {
                const keyParts = key.split('.');
                const len = keyParts.length;
                for (var i = 0; i < len - 1; i++) {
                    var currentKey = keyParts[i];
                    if (!root[currentKey]) root[currentKey] = {}
                    root = root[currentKey];
                }
                root[keyParts[len - 1]] = val;
            };

            class Sshtate {
                constructor(initialState) {
                    storeEl = document.createElement('meta');
                    state = initialState || {};
                }
                setState(key, val) {
                    const currentState = this.getState(key);
                    if (JSON.stringify(val) !== JSON.stringify(currentState)) {
                        set(state, key, val);
                        storeEl.dispatchEvent(new CustomEvent(`Sshtate.${key}`, {
                            bubbles: true,
                            detail: val
                        }));
                    }
                }
                listen(key, cb) {
                    storeEl.addEventListener(`Sshtate.${key}`, ({ detail }) => cb(detail));
                }
                getState(key) {
                    if (key === undefined) return state;
                    let valueOnkey = state;
                    const nestedKey = key.split('.');
                    for (let i = 0; i < nestedKey.length; i++) {
                        valueOnkey = valueOnkey[nestedKey[i]];
                    }
                    return valueOnkey;
                }
            }

            win.Sshtate = Sshtate;
        })(window);

        const Food = new Sshtate({ bread: { baguette: 2, loaf: 6 }, fruit: { apples: 11, bananas: 1 } });

        Food.listen('bread.loaf', (ev) => console.log(ev));

        Food.setState('bread.loaf', 25);
        Food.setState('bread.loaf', 23);
        Food.setState('bread.loaf', 21);

    </script>
</body>

</html>